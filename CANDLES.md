# Candle Aggregation System

## Overview

Candles (OHLCV data) are **derived from trades**, not fetched separately. This ensures accuracy and efficiency.

## How It Works

1. **Trades are ingested** via WebSocket in real-time
2. **Candles are aggregated** periodically from trades
3. **Only new trades** since the last candle are processed (incremental)

## Candle Intervals

- **1 minute** (1m) - For detailed charts
- **5 minutes** (5m) - Short-term trading
- **1 hour** (1h) - Default view
- **6 hours** (6h) - Medium-term trends
- **24 hours** (24h) - Long-term analysis

## Aggregation Process

For each token and interval:
1. Find the last candle timestamp
2. Get all trades since that timestamp
3. Group trades by candle interval
4. Calculate OHLCV (Open, High, Low, Close, Volume)
5. Upsert candles (create new or update existing)

## Running Candle Aggregation

### Manual Run

```bash
npm run aggregate:candles
```

### Automatic (PM2 Cron)

The PM2 ecosystem config includes a cron job that runs every 5 minutes:

```javascript
cron_restart: '*/5 * * * *' // Every 5 minutes
```

### System Cron (Alternative)

Add to crontab for more control:

```bash
# Edit crontab
crontab -e

# Add this line (runs every 5 minutes)
*/5 * * * * cd /home/hendo420/autoTrader && npm run aggregate:candles >> /dev/null 2>&1
```

## Efficiency

- **Incremental**: Only processes new trades since last aggregation
- **Batch processing**: Uses transactions for better performance
- **Token filtering**: Only processes tokens that have trades
- **Error handling**: Continues processing even if one token fails

## API Usage

Candles are fetched via:

```
GET /api/tokens/{mintAddress}/candles?interval=1h&limit=100
```

Parameters:
- `interval`: 1m, 5m, 1h, 6h, 24h (default: 1h)
- `limit`: Number of candles to return (default: 100)
- `start_time`: Optional start timestamp
- `end_time`: Optional end timestamp

## Data Flow

```
WebSocket Trade Feed
    ↓
Trades Table (real-time)
    ↓
Candle Aggregation (every 5 minutes)
    ↓
Candles Table
    ↓
API Endpoints
    ↓
Charts/UI
```

## Why This Approach?

1. **Accuracy**: Candles match actual trades, not approximations
2. **Efficiency**: No need to poll APIs for each token
3. **Real-time**: Trades are captured instantly
4. **Flexible**: Can regenerate candles with different intervals
5. **Scalable**: Incremental processing handles large datasets

## Monitoring

Check logs:
```bash
# PM2 logs
pm2 logs autotrader-aggregate-candles

# Or view log files
tail -f logs/aggregate-candles-out.log
```

## Troubleshooting

### Candles not updating?

1. Check if trade ingestion is running: `pm2 status autotrader-ingest-trades`
2. Check if candle aggregation is running: `pm2 status autotrader-aggregate-candles`
3. Check logs for errors: `pm2 logs autotrader-aggregate-candles`
4. Run manually to see errors: `npm run aggregate:candles`

### Missing candles for a token?

- Candle aggregation only processes tokens that have trades
- If a token has no trades, it won't have candles
- Historical candles can be regenerated by clearing the candles table and re-running aggregation

